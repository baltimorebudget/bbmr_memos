```{r setup, include=FALSE}
options(tinytex.verbose = FALSE)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

options(knitr.table.format = "latex",
        knitr.kable.NA = '',
        knitr.table.vline = "")

```

\hfill \break

\hfill \break

\hfill Fiscal 2024: Target Level of Service \hfill \hfill \hfill \break

`r agency_clean` Agency Head/Fiscal Officer \hfill \hfill `r format(Sys.Date(), format="%B %d %Y")`

```{r Total Budget, echo = FALSE, warning = FALSE}

df <- data %>%
  filter(`Agency Name` == agency & `Fund ID` == 1001) %>%
  ungroup() %>%
  select(-`Fund Name`, -`Agency ID`, -`Agency Name`, -`% - Change vs Adopted`, -`$ - Change vs Adopted`)

total <- scales::dollar(sum(df$`FY24 TLS`, na.rm = TRUE), style_negative = "parens")

```


**Fiscal Year 2024 TLS GF Amount: `r total `**

Your agency’s Fiscal Year 2024 Target Level of Service (TLS) General Fund amount is included below. The table summarizes your agency’s budget by service. Your Budget Analyst is available to answer specific questions regarding changes reflected in the TLS budget amounts.

```{r TLS Table, echo = FALSE, warning = FALSE}

output <- df %>%
  group_by(Service) %>%
  summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  select(-`Fund ID`) %>%
  adorn_totals(where = "row", name = "Agency General Fund Total")

output %>%
  format_table_numbers() %>%
  kable(longtable = TRUE, booktabs = TRUE,
      format = "latex", escape = TRUE,
      align = c("l", rep("r", 4))) %>%
  column_spec(1, width = "2.6in") %>%
  column_spec(2:5, width = ".9in") %>%
  kable_styling(latex_options = "striped", font_size = 10) %>%
  row_spec(nrow(output), bold = TRUE) %>%
  row_spec(0, bold = TRUE, align = "c", background = "#19315f", color = "white")

```

```{r Enhancements}

# enh <- enhancement %>%
#   filter(Agency == x)
# 
# if (dim(enh)[0] > 0 ) {
#   cat("Your agency is receiving additional budget actions as part of the Financial Recommendation.")
#   
#   enh %>%
#     format_table()
# }

```

```{r Missing Performance Measures, results='asis'}

pms = performance %>%
  filter(`Agency Name` == agency & (`Actual 2023` != "N/A" | `Actual 2022` == "N/A" | `Target 2024` == "N/A")) %>%
  select(-`Agency Name`) %>%
  unite("Service", `Service ID`:`Service Name`, sep = ": ", remove = TRUE)

pms[pms == "N/A"] <- "Missing"

if (dim(pms)[1] > 0) {
  cat(paste0("Your agency is missing one or more data points for your performance data as of Tuesday, March 14, 2023. The table below summarizes missing data that needs to be updated in Scorecard by March 31, 2023."))
  
  pms %>%
  kable(longtable = TRUE, booktabs = TRUE,
      format = "latex", escape = TRUE,
      align = c("l", "l", rep("r", 3))) %>%
  collapse_rows(1:2, valign = "top", latex_hline = "major", row_group_label_position = "stack") %>%
  column_spec(1, width = ".25in") %>%
  column_spec(2, width = "3.0in") %>%
  column_spec(3:5, width = "1.0in") %>%
  kable_styling(latex_options = "striped", font_size = 10) %>%
  row_spec(0, bold = TRUE, align = "c", background = "#19315f", color = "white")

}



```

\backgroundsetup{contents={}}